name: Build & Deploy to Azure Static Web Apps

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # needed for OIDC (optional, if using Workload Identity)

env:
  NODE_VERSION: "22"
  OUTPUT_DIR: out

jobs:
  # ── Build ──────────────────────────────────────────────────────────────────
  build_and_deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    # Skip close-without-merge PRs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build static export
        run: npm run build
        # Outputs to ./out (set by next.config.ts output: "export")
        env:
          NEXT_PUBLIC_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.NEXT_PUBLIC_APPINSIGHTS_CONNECTION_STRING }}

      - name: Copy resume.json into api/ for function deployment
        run: cp src/data/resume.json api/resume.json

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "out"        # pre-built Next.js static export
          api_location: "api"        # Azure Functions for /api/chat
          output_location: ""        # already built — no sub-directory
          skip_app_build: true       # we already built above
        env:
          IS_STATIC_EXPORT: true
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          APPLICATIONINSIGHTS_CONNECTION_STRING: ${{ secrets.NEXT_PUBLIC_APPINSIGHTS_CONNECTION_STRING }}

  # ── Close PR (remove preview environment) ─────────────────────────────────
  close_pull_request:
    name: Close Pull Request Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Close preview
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"
